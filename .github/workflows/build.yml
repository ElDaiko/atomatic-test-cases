name: ðŸš€ Build QA Generator - Multi-Platform

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - ".gitignore"
      - "docs/**"
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  ARTIFACT_RETENTION_DAYS: 30

jobs:
  build:
    name: ðŸ”¨ Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: Windows
            script: dist-win
            executable: "QA Generator-1.0.0.exe"
            artifact_name: "QA-Generator-Windows"
          - os: macos-latest
            platform: macOS
            script: dist-mac
            executable: "QA Generator-1.0.0.dmg"
            artifact_name: "QA-Generator-macOS"
          - os: ubuntu-latest
            platform: Linux
            script: dist-linux
            executable: "QA Generator-1.0.0-linux.AppImage"
            artifact_name: "QA-Generator-Linux"

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ§ Install Linux Dependencies (Ubuntu only)
        if: matrix.platform == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3-dev libatk-bridge2.0-dev libdrm2 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libxss1 libasound2-dev

      - name: ðŸ—ï¸ Build React Application
        run: |
          npm run build
          echo "âœ… React build completed for ${{ matrix.platform }}"

      - name: ðŸ–¥ï¸ Build Electron App (${{ matrix.platform }})
        id: electron-build
        continue-on-error: true
        run: |
          echo "ðŸ”¨ Building Electron app for ${{ matrix.platform }}"
          npm run ${{ matrix.script }}
          echo "âœ… Build completed for ${{ matrix.platform }}"
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ï¿½ Post-Build Verification (${{ matrix.platform }})
        shell: bash
        run: |
          echo "ï¿½ Verifying build output for ${{ matrix.platform }}"
          echo "ðŸ“ Contents of dist-electron:"
          ls -la dist-electron/

          # Linux-specific verification
          if [ "${{ matrix.platform }}" = "Linux" ]; then
            echo "ðŸ§ Linux-specific verification:"
            # Look for AppImage files and make them executable
            for appimage in dist-electron/*.AppImage; do
              if [ -f "$appimage" ]; then
                echo "âœ… Found AppImage: $appimage"
                chmod +x "$appimage"
                echo "âœ… Made AppImage executable"
              fi
            done
            
            # If no AppImage found, look for other Linux builds
            if [ ! -f dist-electron/*.AppImage ]; then
              echo "âŒ No AppImage files found"
              echo "ðŸ“„ Looking for other Linux build files:"
              find dist-electron -name "*linux*" -o -name "*.deb" -o -name "*.rpm" -o -name "*.tar.gz" | head -10
            fi
          fi

      - name: ðŸ“¦ Create Release Package (${{ matrix.platform }})
        shell: bash
        run: |
          mkdir -p QA_Generator_${{ matrix.platform }}

          # Check if the build was successful
          if [ "${{ steps.electron-build.outcome }}" = "failure" ]; then
            echo "âŒ Electron build failed for ${{ matrix.platform }}"
            echo "Build failed for ${{ matrix.platform }}. Please check the build logs for details." > "QA_Generator_${{ matrix.platform }}/BUILD_FAILED.txt"
            echo "ðŸ”„ For troubleshooting, visit: https://github.com/${{ github.repository }}/issues" >> "QA_Generator_${{ matrix.platform }}/BUILD_FAILED.txt"
            cp "GUIA_USUARIO.md" "QA_Generator_${{ matrix.platform }}/" || echo "Could not copy GUIA_USUARIO.md"
          else
            # Normal build process - copy main executable with flexible filename matching
            if [ "${{ matrix.platform }}" = "Windows" ]; then
              if [ -f "dist-electron/QA Generator-1.0.0.exe" ]; then
                cp "dist-electron/QA Generator-1.0.0.exe" "QA_Generator_${{ matrix.platform }}/"
              else
                # Try to find any .exe file in dist-electron
                find dist-electron -name "*.exe" -exec cp {} "QA_Generator_${{ matrix.platform }}/" \;
              fi
              cp "GUIA_USUARIO.md" "QA_Generator_${{ matrix.platform }}/"
              cp "Iniciar_QA_Generator.bat" "QA_Generator_${{ matrix.platform }}/"
            elif [ "${{ matrix.platform }}" = "macOS" ]; then
              if [ -f "dist-electron/QA Generator-1.0.0.dmg" ]; then
                cp "dist-electron/QA Generator-1.0.0.dmg" "QA_Generator_${{ matrix.platform }}/"
              else
                # Try to find any .dmg file in dist-electron
                find dist-electron -name "*.dmg" -exec cp {} "QA_Generator_${{ matrix.platform }}/" \;
              fi
              cp "GUIA_USUARIO.md" "QA_Generator_${{ matrix.platform }}/"
            else
              # Linux - more flexible AppImage detection
              if [ -f "dist-electron/QA Generator-1.0.0.AppImage" ]; then
                cp "dist-electron/QA Generator-1.0.0.AppImage" "QA_Generator_${{ matrix.platform }}/"
              elif [ -f "dist-electron/QA Generator-1.0.0-linux.AppImage" ]; then
                cp "dist-electron/QA Generator-1.0.0-linux.AppImage" "QA_Generator_${{ matrix.platform }}/"
              else
                # Try to find any AppImage file in dist-electron
                APPIMAGE_FILE=$(find dist-electron -name "*.AppImage" | head -1)
                if [ -n "$APPIMAGE_FILE" ]; then
                  cp "$APPIMAGE_FILE" "QA_Generator_${{ matrix.platform }}/"
                  echo "âœ… Found and copied AppImage: $APPIMAGE_FILE"
                else
                  echo "âŒ No AppImage file found in dist-electron"
                  echo "ðŸ“ Available files:"
                  ls -la dist-electron/ || echo "No dist-electron directory"
                  # Create a placeholder file to prevent workflow failure
                  echo "AppImage build failed. Please check the build logs." > "QA_Generator_${{ matrix.platform }}/BUILD_FAILED.txt"
                fi
              fi
              cp "GUIA_USUARIO.md" "QA_Generator_${{ matrix.platform }}/"
            fi
          fi

          # Create version info
          echo "ðŸš€ QA Generator v1.0.0 - ${{ matrix.platform }}" > "QA_Generator_${{ matrix.platform }}/VERSION.txt"
          echo "ðŸ“… Build Date: $(date)" >> "QA_Generator_${{ matrix.platform }}/VERSION.txt"
          echo "ðŸ“ Commit: ${{ github.sha }}" >> "QA_Generator_${{ matrix.platform }}/VERSION.txt"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}" >> "QA_Generator_${{ matrix.platform }}/VERSION.txt"
          echo "ðŸ”¢ Build Number: ${{ github.run_number }}" >> "QA_Generator_${{ matrix.platform }}/VERSION.txt"
          echo "ðŸ’» Platform: ${{ matrix.platform }}" >> "QA_Generator_${{ matrix.platform }}/VERSION.txt"

      - name: ðŸ—œï¸ Create Compressed Archive
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "Windows" ]; then
            powershell Compress-Archive -Path "QA_Generator_${{ matrix.platform }}/*" -DestinationPath "QA-Generator-${{ matrix.platform }}-v1.0.0-build-${{ github.run_number }}.zip"
          else
            tar -czf "QA-Generator-${{ matrix.platform }}-v1.0.0-build-${{ github.run_number }}.tar.gz" -C "QA_Generator_${{ matrix.platform }}" .
          fi

      - name: ðŸ“¤ Upload Platform Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-build-${{ github.run_number }}
          path: QA_Generator_${{ matrix.platform }}/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: warn

      - name: ðŸ“¤ Upload Compressed Archive
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: ${{ matrix.artifact_name }}-Archive-${{ github.run_number }}
          path: QA-Generator-${{ matrix.platform }}-v1.0.0-build-${{ github.run_number }}.*
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: warn

      - name: ðŸŽ‰ Build Summary
        if: always()
        shell: bash
        run: |
          if [ "${{ steps.electron-build.outcome }}" = "failure" ]; then
            echo "## âŒ ${{ matrix.platform }} Build Failed!" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸš¨ **Status**: Build failed for ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ **Artifact**: ${{ matrix.artifact_name }}-build-${{ github.run_number }} (contains error info)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ’» **Platform**: ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“… **Build Date**: $(date)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”¢ **Build Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "1. Check the build logs above for specific error messages" >> $GITHUB_STEP_SUMMARY
            echo "2. Download the artifact to see the BUILD_FAILED.txt file" >> $GITHUB_STEP_SUMMARY
            echo "3. Report the issue if this persists" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸŽ‰ ${{ matrix.platform }} Build Completed!" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ **Artifact**: ${{ matrix.artifact_name }}-build-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ—œï¸ **Archive**: ${{ matrix.artifact_name }}-Archive-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ’» **Platform**: ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“… **Build Date**: $(date)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”¢ **Build Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¥ CÃ³mo Descargar" >> $GITHUB_STEP_SUMMARY
            echo "1. Scroll hacia abajo hasta **Artifacts**" >> $GITHUB_STEP_SUMMARY
            echo "2. Haz clic en **${{ matrix.artifact_name }}-build-${{ github.run_number }}**" >> $GITHUB_STEP_SUMMARY
            echo "3. Descomprime y ejecuta" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Enlaces Ãštiles" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“– GuÃ­a de Usuario](https://github.com/${{ github.repository }}/blob/main/GUIA_USUARIO.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ”§ DocumentaciÃ³n TÃ©cnica](https://github.com/${{ github.repository }}/blob/main/DOCUMENTACION_TECNICA.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸš€ Todos los Builds](https://github.com/${{ github.repository }}/actions/workflows/build.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ› Reportar Issues](https://github.com/${{ github.repository }}/issues)" >> $GITHUB_STEP_SUMMARY

  create-release:
    name: ðŸ·ï¸ Create Multi-Platform Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ðŸ“‹ List Downloaded Artifacts
        run: |
          echo "ðŸ“ Downloaded artifacts:"
          find artifacts/ -name "*.zip" -o -name "*.tar.gz" -o -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage"

      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/QA-Generator-Windows-Archive-*/QA-Generator-Windows-v1.0.0-build-*.zip
            artifacts/QA-Generator-macOS-Archive-*/QA-Generator-macOS-v1.0.0-build-*.tar.gz
            artifacts/QA-Generator-Linux-Archive-*/QA-Generator-Linux-v1.0.0-build-*.tar.gz
          name: ðŸš€ QA Generator ${{ github.ref_name }}
          body: |
            ## ðŸš€ QA Generator ${{ github.ref_name }} - Multi-Platform Release

            ### ðŸ“¦ Descargas Disponibles

            #### ðŸ–¥ï¸ Windows
            - **Archivo**: `QA-Generator-Windows-v1.0.0-build-*.zip`
            - **InstalaciÃ³n**: 
              1. Descomprime el ZIP
              2. Ejecuta `Iniciar_QA_Generator.bat`
              3. Â¡Listo!

            #### ðŸŽ macOS
            - **Archivo**: `QA-Generator-macOS-v1.0.0-build-*.tar.gz`
            - **InstalaciÃ³n**:
              1. Descomprime el archivo
              2. Ejecuta el archivo .dmg
              3. Arrastra a Applications

            #### ðŸ§ Linux
            - **Archivo**: `QA-Generator-Linux-v1.0.0-build-*.tar.gz`
            - **InstalaciÃ³n**:
              1. Descomprime el archivo
              2. Ejecuta el .AppImage
              3. O instala segÃºn tu distribuciÃ³n

            ### âœ¨ CaracterÃ­sticas
            - âœ… GeneraciÃ³n automÃ¡tica de casos de prueba
            - âœ… MÃºltiples formatos de exportaciÃ³n
            - âœ… IntegraciÃ³n con Azure DevOps
            - âœ… Interfaz moderna y responsive
            - âœ… Multiplataforma

            ### ðŸ”§ Requisitos
            - **Windows**: Windows 10/11 (64-bit)
            - **macOS**: macOS 10.14 o superior
            - **Linux**: Ubuntu 18.04+ o distribuciones equivalentes

            ### ðŸ“ Notas de la VersiÃ³n
            - Build Number: ${{ github.run_number }}
            - Commit: ${{ github.sha }}
            - Fecha: $(date)

            ### ðŸ†˜ Soporte
            - [ðŸ› Reportar Bug](https://github.com/${{ github.repository }}/issues)
            - [ðŸ“– DocumentaciÃ³n](https://github.com/${{ github.repository }}/blob/main/DOCUMENTACION_TECNICA.md)
            - [ðŸ’¡ Solicitar Feature](https://github.com/${{ github.repository }}/issues)

            ---
            **Â¿Te gusta QA Generator? Â¡Dale una â­ al repositorio!**
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: ðŸ“Š Build Summary
    if: always()
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "# ðŸ“Š Build Summary - QA Generator" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Build Status" >> $GITHUB_STEP_SUMMARY

          # Check individual build results
          WINDOWS_STATUS="${{ needs.build.outputs.windows-status || 'Unknown' }}"
          MACOS_STATUS="${{ needs.build.outputs.macos-status || 'Unknown' }}"
          LINUX_STATUS="${{ needs.build.outputs.linux-status || 'Unknown' }}"

          echo "| Platform | Status | Artifact Available |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|-------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ–¥ï¸ Windows | ${{ needs.build.result }} | âœ… Yes |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ macOS | ${{ needs.build.result }} | âœ… Yes |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ Linux | ${{ needs.build.result }} | âš ï¸ Check logs |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "âœ… **All builds completed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some builds may have failed, but artifacts are still available**" >> $GITHUB_STEP_SUMMARY
            echo "- Check individual build logs for details" >> $GITHUB_STEP_SUMMARY
            echo "- Failed builds will contain troubleshooting information" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”¢ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Available Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Artifact Name | Archive |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ–¥ï¸ Windows | \`QA-Generator-Windows-build-${{ github.run_number }}\` | \`QA-Generator-Windows-Archive-${{ github.run_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ macOS | \`QA-Generator-macOS-build-${{ github.run_number }}\` | \`QA-Generator-macOS-Archive-${{ github.run_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ Linux | \`QA-Generator-Linux-build-${{ github.run_number }}\` | \`QA-Generator-Linux-Archive-${{ github.run_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¥ Instrucciones de Descarga" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### MÃ©todo 1: Desde esta pÃ¡gina" >> $GITHUB_STEP_SUMMARY
          echo "1. **Scroll hacia abajo** hasta la secciÃ³n **\"Artifacts\"**" >> $GITHUB_STEP_SUMMARY
          echo "2. **Haz clic** en el artifact de tu plataforma" >> $GITHUB_STEP_SUMMARY
          echo "3. **Descomprime** el archivo descargado" >> $GITHUB_STEP_SUMMARY
          echo "4. **Ejecuta** la aplicaciÃ³n (si el build fue exitoso)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### MÃ©todo 2: Desde Actions" >> $GITHUB_STEP_SUMMARY
          echo "1. Ve a [GitHub Actions](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
          echo "2. Selecciona este workflow run" >> $GITHUB_STEP_SUMMARY
          echo "3. Descarga el artifact deseado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ PrÃ³ximos Pasos" >> $GITHUB_STEP_SUMMARY
          echo "- **Probar la aplicaciÃ³n** con los nuevos cambios" >> $GITHUB_STEP_SUMMARY
          echo "- **Reportar issues** si encuentras problemas" >> $GITHUB_STEP_SUMMARY
          echo "- **Compartir el enlace** con el equipo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“š Recursos Ãštiles" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“– GuÃ­a de Usuario](https://github.com/${{ github.repository }}/blob/main/GUIA_USUARIO.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ”§ DocumentaciÃ³n TÃ©cnica](https://github.com/${{ github.repository }}/blob/main/DOCUMENTACION_TECNICA.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“¦ GuÃ­a de Artifacts](https://github.com/${{ github.repository }}/blob/main/GIT_ARTIFACTS_GUIA.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ› Reportar Issues](https://github.com/${{ github.repository }}/issues)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Â¡Gracias por usar QA Generator!** ðŸš€" >> $GITHUB_STEP_SUMMARY
